name: deploy

on:
  workflow_dispatch:     # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ í™œì„±í™”
  push:
    branches: ["dev"]    # dev ë¸Œëžœì¹˜ì— í‘¸ì‹œë˜ë©´ ìžë™ ì‹¤í–‰

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # GitHub Secretsì—ì„œ ê°’ì„ ê°€ì ¸ì™€ì„œ envë¡œ ë¯¸ë¦¬ ë§¤í•‘
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION:      ap-northeast-2
      AWS_ACCOUNT_ID:  ${{ secrets.AWS_ACCOUNT_ID }}
      ECR_REPOSITORY:  promesa-repo

      RDS_URL:         ${{ secrets.RDS_URL }}
      RDS_USERNAME:    ${{ secrets.RDS_USERNAME }}
      RDS_PASSWORD:    ${{ secrets.RDS_PASSWORD }}
      REDIS_HOST:      ${{ secrets.REDIS_HOST }}
      REDIS_PORT:      ${{ secrets.REDIS_PORT }}

    steps:
      # 1) ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2) gradlewì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 3) AWS ìžê²©ì¦ëª… ì„¤ì •
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ap-northeast-2

      # 4) JDK 17 ì„¤ì¹˜ & Gradle ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸)
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version:  '17'
          distribution: 'temurin'

      - name: Gradle Build Run (skip tests)
        run: ./gradlew build -x test

      # 5) ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸í•˜ê¸°
      - name: Show build/libs contents
        run: |
          echo "ðŸ”Ž build/libs ë””ë ‰í„°ë¦¬ ë‚´ë¶€:"
          ls -al build/libs

      # 6) Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Docker image
        run: |
          IMAGE_TAG=${{ github.sha }}
          # Dockerfileì´ ìžˆëŠ” í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ ë¹Œë“œ
          docker build -t promesa:${IMAGE_TAG} .
          docker tag promesa:${IMAGE_TAG} promesa:latest

      # 7) ECR ë¡œê·¸ì¸ (Docker CLIìš© í† í°)
      - name: ECR Login
        uses: aws-actions/amazon-ecr-login@v1
        with:
          region: ${{ env.AWS_REGION }}

      # 8) Docker ì´ë¯¸ì§€ Tag & Push to ECR
      - name: Tag and Push to ECR
        run: |
          IMAGE_TAG=${{ github.sha }}
          ECR_REGISTRY=${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com

          # 1) SHA íƒœê·¸ë¡œ tag & push
          docker tag promesa:${IMAGE_TAG} ${ECR_REGISTRY}/${{ env.ECR_REPOSITORY }}:${IMAGE_TAG}
          docker push ${ECR_REGISTRY}/${{ env.ECR_REPOSITORY }}:${IMAGE_TAG}

          # 2) latest íƒœê·¸ë¡œë„ tag & push
          docker tag promesa:latest ${ECR_REGISTRY}/${{ env.ECR_REPOSITORY }}:latest
          docker push ${ECR_REGISTRY}/${{ env.ECR_REPOSITORY }}:latest

      # .env íŒŒì¼ ìƒì„±
      - name: Create .env file
        run: |
          cat > .env <<EOF
          RDS_URL=${{ secrets.RDS_URL }}
          RDS_USERNAME=${{ secrets.RDS_USERNAME }}
          RDS_PASSWORD=${{ secrets.RDS_PASSWORD }}
          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          AWS_REGION=ap-northeast-2
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          EOF

      # 9) AppSpec, JAR, ìŠ¤í¬ë¦½íŠ¸ í´ë”ë¥¼ ZIPìœ¼ë¡œ ë¬¶ê¸°
      - name: Zip for CodeDeploy
        run: |
          zip -r latest.zip \
            appspec.yml \
            build/libs/promesa-0.0.1-SNAPSHOT.jar \
            scripts/ \
            .env

      # 10) (ë””ë²„ê·¸) ZIP ë‚´ë¶€ í™•ì¸í•˜ê¸°
      - name: List contents of latest.zip
        run: |
          echo "ðŸ” ZIP ë‚´ë¶€ íŒŒì¼ ëª©ë¡:"
          unzip -l latest.zip

      # 11) S3ë¡œ ZIP ì—…ë¡œë“œ
      - name: Upload to S3
        run: |
          aws s3 cp latest.zip s3://ceos-promesa/latest.zip

      # 12) CodeDeploy ë°°í¬ ìš”ì²­
      - name: Request to CodeDeploy
        run: |
          aws deploy create-deployment \
            --application-name test-application \
            --deployment-config-name CodeDeployDefault.AllAtOnce \
            --deployment-group-name Promesa-BlueGreen-DeploymentGroup \
            --s3-location bucket=ceos-promesa,bundleType=zip,key=latest.zip
